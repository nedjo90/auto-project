# Story 7.3: Moderation Actions (Deactivate, Warn, Reactivate)

Status: ready-for-dev

## Story

As a moderator,
I want to take actions on reported content (deactivate listings, deactivate accounts, send warnings, reactivate),
so that I can protect the platform's reputation while being fair to users.

## Acceptance Criteria (BDD)

**Given** a moderator reviews a report
**When** they choose to deactivate a listing (FR39)
**Then** the listing status changes to `Suspended`
**And** the listing is hidden from public search
**And** the seller receives a templated notification: "Votre annonce a été mise en pause pour vérification" (smoothed communication)
**And** the action is logged in the audit trail

**Given** a moderator decides to send a warning (FR41)
**When** they select the warning action
**Then** a templated warning message is sent to the user via the platform
**And** the warning is recorded on the user's moderation history
**And** the report status is updated to `Treated`

**Given** a moderator decides to deactivate a user account (FR40)
**When** they confirm the action (double confirmation)
**Then** the user account is suspended (cannot login, listings hidden)
**And** the user receives a notification with the reason
**And** the action is logged in the audit trail

**Given** a moderator wants to reactivate a listing or account
**When** the seller has corrected the issue
**Then** the moderator can reactivate via a single action
**And** the listing/account becomes visible again
**And** the reactivation is logged

## Tasks / Subtasks

### T1: Backend - ModerationAction Entity & Audit Trail (AC1, AC2, AC3, AC4)
- [ ] T1.1: Define `ModerationAction` entity in `db/schema.cds` with fields: ID, report (association to Report), moderator (association to User), actionType (enum: DeactivateListing/DeactivateAccount/Warning/ReactivateListing/ReactivateAccount/Dismiss), reason (String(1000)), targetType (enum: Listing/User), targetID (UUID), createdAt
- [ ] T1.2: Integrate ModerationAction creation with audit-trail middleware to ensure every action is immutably logged
- [ ] T1.3: Write unit tests for ModerationAction entity creation and audit trail integration

### T2: Backend - Deactivate Listing Action (AC1)
- [ ] T2.1: Implement `deactivateListing` action in `srv/moderation-service.cds` accepting: reportID, listingID, reason
- [ ] T2.2: Implement handler in `srv/moderation-service.ts`: validate listing exists and is active, update listing status to `Suspended`, create ModerationAction record, update Report status to `Treated`, trigger notification to seller via notification-hub with template "Votre annonce a été mise en pause pour vérification"
- [ ] T2.3: Ensure suspended listings are excluded from public search queries (add filter in listing-service read handler)
- [ ] T2.4: Authorization: moderator role required
- [ ] T2.5: Write unit tests for deactivateListing (happy path, listing not found, already suspended, authorization)
- [ ] T2.6: Write integration test for full deactivation flow including notification

### T3: Backend - Send Warning Action (AC2)
- [ ] T3.1: Implement `sendWarning` action in `srv/moderation-service.cds` accepting: reportID, userID, warningMessage (optional, uses template if empty)
- [ ] T3.2: Implement handler in `srv/moderation-service.ts`: validate user exists, create ModerationAction record with actionType `Warning`, update Report status to `Treated`, send warning notification to user via notification-hub, increment user's warning count in moderation history
- [ ] T3.3: Use configurable warning templates from `ConfigModerationRule` table (not hardcoded)
- [ ] T3.4: Authorization: moderator role required
- [ ] T3.5: Write unit tests for sendWarning (happy path, user not found, template rendering, authorization)
- [ ] T3.6: Write integration test for warning flow including notification delivery

### T4: Backend - Deactivate Account Action (AC3)
- [ ] T4.1: Implement `deactivateAccount` action in `srv/moderation-service.cds` accepting: reportID, userID, reason
- [ ] T4.2: Implement handler in `srv/moderation-service.ts`: validate user exists and is active, update user account status to `Suspended`, suspend all active listings for this user (batch update to `Suspended` status), create ModerationAction record, update Report status to `Treated`, send notification to user with reason via notification-hub, invalidate user sessions (if applicable)
- [ ] T4.3: Implement double confirmation requirement: action requires a `confirmToken` parameter that must match a token generated by a preceding `requestAccountDeactivation` action (or use a `confirmed: true` boolean flag validated server-side)
- [ ] T4.4: Authorization: moderator role required
- [ ] T4.5: Write unit tests for deactivateAccount (happy path, user not found, already suspended, without confirmation, authorization)
- [ ] T4.6: Write integration test for full account deactivation flow including cascading listing suspension

### T5: Backend - Reactivate Action (AC4)
- [ ] T5.1: Implement `reactivateListing` action in `srv/moderation-service.cds` accepting: listingID, reason
- [ ] T5.2: Implement `reactivateAccount` action in `srv/moderation-service.cds` accepting: userID, reason
- [ ] T5.3: Implement reactivateListing handler: validate listing is Suspended, update listing status back to `Active`, create ModerationAction record, send notification to seller: "Votre annonce a été réactivée"
- [ ] T5.4: Implement reactivateAccount handler: validate account is Suspended, update account status to Active, note: previously suspended listings are NOT automatically reactivated (moderator must reactivate individually), create ModerationAction record, send notification to user
- [ ] T5.5: Authorization: moderator role required
- [ ] T5.6: Write unit tests for both reactivation actions
- [ ] T5.7: Write integration tests for reactivation flows

### T6: Backend - Dismiss Report Action (AC1, AC2, AC3, AC4)
- [ ] T6.1: Implement `dismissReport` action in `srv/moderation-service.cds` accepting: reportID, reason
- [ ] T6.2: Implement handler: update Report status to `Dismissed`, create ModerationAction with actionType `Dismiss`, log in audit trail
- [ ] T6.3: Write unit tests for dismiss action

### T7: Frontend - Moderation Action Buttons (AC1, AC2, AC3, AC4)
- [ ] T7.1: Create `src/components/moderation/moderation-actions.tsx` component rendering contextual action buttons based on report target type and current status
- [ ] T7.2: For listing targets: show "Suspendre l'annonce" (deactivate listing), "Envoyer un avertissement" (send warning), "Rejeter le signalement" (dismiss)
- [ ] T7.3: For user targets: show "Suspendre le compte" (deactivate account), "Envoyer un avertissement" (send warning), "Rejeter le signalement" (dismiss)
- [ ] T7.4: For suspended targets: show "Réactiver l'annonce" or "Réactiver le compte" as applicable
- [ ] T7.5: Implement reason input: each action opens a confirmation dialog with optional reason text field
- [ ] T7.6: Implement double confirmation for account deactivation: first click shows warning dialog explaining consequences, second click executes action
- [ ] T7.7: Integrate action buttons into report detail page (Story 7.2, T4)
- [ ] T7.8: Write component tests for moderation-actions with all action types

### T8: Frontend - Action Feedback & State Updates (AC1, AC2, AC3, AC4)
- [ ] T8.1: On successful action: show success toast with action summary, update report status in UI without full page reload, navigate back to queue or show next report
- [ ] T8.2: On action failure: show error toast with details, keep current state, allow retry
- [ ] T8.3: Create API client functions: `deactivateListing(data)`, `sendWarning(data)`, `deactivateAccount(data)`, `reactivateListing(data)`, `reactivateAccount(data)`, `dismissReport(data)`
- [ ] T8.4: Write integration tests for action API calls and UI state updates

## Dev Notes

### Architecture & Patterns
- All moderation actions follow a consistent pattern: validate, execute, create ModerationAction record, update report status, send notification, log audit trail. This should be implemented as a shared handler utility to avoid code duplication.
- The audit trail is mandatory for every moderation action (NFR14). The audit-trail middleware should automatically capture: who (moderator ID), what (action type), when (timestamp), target (entity type + ID), and reason.
- Notifications use "smoothed communication" - messages are worded carefully to be informative but not aggressive (e.g., "mise en pause pour vérification" instead of "suspendue pour violation").
- Double confirmation for account deactivation is a UX safety measure since account deactivation is the most severe action and cascades to all listings.
- Reactivation of an account does NOT automatically reactivate its listings. This is by design to force moderator review of each listing individually.

### Key Technical Context
- **Stack:** SAP CAP backend, Next.js 16 frontend, PostgreSQL, Azure
- **Moderation service:** moderation-service.cds + moderation-service.ts
- **Report entity:** In CDS schema with type and severity classification (ConfigReportReason table for categories)
- **Moderation cockpit:** src/app/(dashboard)/moderation/* (SPA behind auth, moderator role required)
- **Actions:** Deactivate listing, deactivate account, send warning, reactivate
- **Seller history:** View all past reports, seller rating, account age
- **RBAC:** Moderator role required for all moderation endpoints
- **Audit trail:** All moderation actions logged via audit-trail middleware
- **Notifications:** Notify seller of moderation actions via notification-hub
- **ConfigModerationRule:** Configurable moderation rules from DB
- **Testing:** >=90% unit, >=80% integration, component tests for all moderation UI

### Naming Conventions
- CDS: PascalCase entities, camelCase elements
- Frontend: kebab-case files, PascalCase components
- All technical naming in English

### Anti-Patterns (FORBIDDEN)
- Hardcoded report categories (use ConfigReportReason table)
- Hardcoded moderation rules (use ConfigModerationRule table)
- Skipping audit trail on moderation actions
- French in code

### Project Structure Notes
Backend: srv/moderation-service.cds + .ts, db/schema.cds (Report, ModerationAction entities)
Frontend: src/app/(dashboard)/moderation/page.tsx (reports queue), src/app/(dashboard)/moderation/reports/[id]/page.tsx (report detail), src/app/(dashboard)/moderation/sellers/[id]/page.tsx (seller history), src/components/moderation/ (report-card, report-detail, seller-history, moderation-actions)

### References
- [Source: _bmad-output/planning-artifacts/architecture.md]
- [Source: _bmad-output/planning-artifacts/prd.md]
- [Source: _bmad-output/planning-artifacts/stories/epic-7/story-7.3-moderation-actions.md]

## Dev Agent Record

### Agent Model Used
### Completion Notes List
### Change Log
### File List
